<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4 sm:p-6">
  <div class="container mx-auto">
    <a href="/confirm.html" class="text-blue-600 underline block mb-2">üì• ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</a>

    <h1 class="text-2xl font-bold text-center mb-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</h1>

    <div class="text-center mb-6">
      <a href="/create.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 inline-block">‚ûï
        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</a>
    </div>

    <div id="list" class="space-y-4 max-w-2xl mx-auto text-gray-800 px-2"></div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
    <div class="bg-white px-6 py-4 rounded-lg shadow-lg text-center">
      <p class="text-lg font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
  </div>

  <script>
    let globalData = [];

    function showLoading() {
      document.getElementById("loading").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loading").classList.add("hidden");
    }

    async function loadData() {
      showLoading();
      try {
        const res = await fetch("/api/list");
        const data = await res.json();
        const container = document.getElementById("list");

        globalData = data;

        if (data.length === 0) {
          container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>`;
        } else {
          data.forEach((item, index) => {
            if (item.is_verify === false) {
              const div = document.createElement("div");
              div.className = "bg-white p-4 shadow rounded break-words";
              div.id = index;

              div.innerHTML = `
                  <p><strong>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</strong> ${item.title}</p>
                  <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ:</strong> ${item.creditor}</p>
                  <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°:</strong> ${item.payer}</p>
                  <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${item.description}</p>
                  <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${item.amount} ‡∏ö‡∏≤‡∏ó</p>
                  <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå PromptPay:</strong> ${item.phone_number}</p>
                  <button onclick="toggleQR(${index})" class="mt-2 text-blue-600 underline">‡πÅ‡∏™‡∏î‡∏á QR Code</button>
                  <div id="qr-${index}" class="hidden mt-2 w-full sm:w-32 h-40 border border-dashed flex items-center justify-center text-gray-400 h-fit">QR MOCK
                    <div class="flex justify-center">
    <img src="${data.result}" alt="QR PromptPay" class="w-40 sm:w-32 border rounded" />
  </div>
                    </div>
                  <input type="file" accept="image/*" class="mt-2 w-full" onchange="uploadSlip(event, ${index})" />
                  <div id="slip-${index}" class="mt-2"></div>
                  
                  <button onclick="confirmSlip(${index})" class="mt-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 w-full sm:w-auto">
                    ‚úÖ ‡πÇ‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                  </button>
                `;
              container.appendChild(div);
            }
          });
        }
      } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        console.error(err);
      } finally {
        hideLoading();
      }
    }

    async function uploadSlip(event, index) {
      const file = event.target.files[0];
      const el = document.getElementById(`slip-${index}`);
      el.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
      if (!file) return;

      const formData = new FormData();
      formData.append("slip", file);
      formData.append("id", globalData[index].uuid);

      try {
        const res = await fetch("/api/upload-slip", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) throw new Error("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");

        const result = await res.json();
        globalData[index].slip_url = result.slip_url;

        el.innerHTML = `<img src="${result.slip_url}" class="w-full max-w-xs border rounded mt-2" alt="slip" />`;
      } catch (err) {
        el.innerHTML = `<span class="text-red-500">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</span>`;
      }
    }

    async function confirmSlip(index) {
      const id = globalData[index].uuid;

      if (!globalData[index].slip_url) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô");
        return; // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
      }
      try {
        const res = await fetch("/api/confirm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        });

        if (!res.ok) throw new Error("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

        document.getElementById(index).remove();
        alert("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      } catch (err) {
        alert("‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    }

    async function toggleQR(index) {
      const el = document.getElementById(`qr-${index}`);
      if (!el.classList.contains("hidden")) {
        el.classList.add("hidden");
        el.innerHTML = "";
      } else {
        el.classList.remove("hidden");
        el.innerHTML = "";

        const amount = globalData[index].amount;
        const phone_number = globalData[index].phone_number;

        try {
          const res = await fetch("/api/qrcode", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ amount, phone_number }),
          });

          if (!res.ok) {
            const errData = await res.json();
            el.innerHTML = `<span class="text-red-500">‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errData?.error || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"
              }</span>`;
            return;
          }

          const data = await res.json();
          const img = document.createElement("img");
          img.src = data.result;
          img.alt = "QR PromptPay";
          // img.className = "h-fit";
          el.appendChild(img);
        } catch (err) {
          console.error("QR error:", err);
          el.innerHTML = `<span class="text-red-500">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</span>`;
        }
      }
    }

    loadData();
  </script>
</body>

</html>